import React from 'react';
import { 
  InteractiveBarChart, 
  InteractivePieChart, 
  InteractiveTimelineChart,
  ComparisonView 
} from './charts';
import { 
  AnomalyCard, 
  ChangeDetection, 
  DecisionGuide, 
  SimulationSlider 
} from './features';
import { ClarificationOptions } from './ui';
import { 
  TrendingUp, 
  TrendingDown,
  AlertTriangle,
  Target,
  IndianRupee,
  Package,
  ShoppingCart
} from 'lucide-react';

/**
 * ThesysGenUI - Client-Side Rendering Engine for Generative UI
 * 
 * This engine takes a JSON specification (generated by AI) and constructs
 * a dynamic React component tree. It supports:
 * 1. Infinite nesting (Rows, Columns, Grids)
 * 2. Specialized Financial Components ("LEGO Blocks")
 * 3. Interactions (Drill-downs, Actions)
 */

// --- 1. Layout Building Blocks ---

const Container = ({ children, className }) => (
  <div className={`space-y-3 sm:space-y-4 ${className || ''}`}>{children}</div>
);

const Row = ({ children, className }) => (
  <div className={`flex flex-col sm:flex-row gap-3 sm:gap-4 items-stretch sm:items-start ${className || ''}`}>{children}</div>
);

const Column = ({ children, className }) => (
  <div className={`flex flex-col gap-3 sm:gap-4 flex-1 min-w-0 ${className || ''}`}>{children}</div>
);

const DashboardGrid = ({ children }) => (
  <div className="grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4 w-full">{children}</div>
);

const MetricCard = ({ label, value, subtext, icon, trend }) => {
  const getIcon = () => {
    switch(icon) {
      case 'rupee': return <IndianRupee className="w-4 h-4 text-amber-600" />;
      case 'trending-up': return <TrendingUp className="w-4 h-4 text-green-500" />;
      case 'trending-down': return <TrendingDown className="w-4 h-4 text-red-500" />;
      case 'target': return <Target className="w-4 h-4 text-blue-500" />;
      case 'alert': return <AlertTriangle className="w-4 h-4 text-orange-500" />;
      case 'package': return <Package className="w-4 h-4 text-purple-500" />;
      case 'cart': return <ShoppingCart className="w-4 h-4 text-teal-500" />;
      default: return <TrendingUp className="w-4 h-4 text-gray-400" />;
    }
  };
  
  return (
    <div className="bg-white p-3 sm:p-4 rounded-xl border border-gray-200 shadow-sm flex-1 min-w-0">
      <div className="flex justify-between items-start mb-2">
        <span className="text-xs text-gray-500 font-medium truncate">{label}</span>
        {getIcon()}
      </div>
      <div className={`text-lg sm:text-xl font-bold ${trend === 'down' ? 'text-red-600' : trend === 'up' ? 'text-green-600' : 'text-gray-900'}`}>
        {value}
      </div>
      {subtext && <div className="text-xs text-gray-400 mt-1 truncate">{subtext}</div>}
    </div>
  );
};

// Gauge Component for Target Progress
const GaugeCard = ({ label, value, max, status }) => {
  const percentage = max > 0 ? Math.min((value / max) * 100, 100) : 0;
  const getStatusColor = () => {
    switch(status) {
      case 'achieved': return 'bg-green-500';
      case 'on-track': return 'bg-amber-500';
      case 'behind': return 'bg-red-500';
      default: return 'bg-blue-500';
    }
  };
  const getStatusText = () => {
    switch(status) {
      case 'achieved': return 'üéØ Target Hit!';
      case 'on-track': return 'üëç On Track';
      case 'behind': return '‚ö†Ô∏è Behind';
      default: return `${percentage.toFixed(0)}%`;
    }
  };
  
  return (
    <div className="bg-white p-4 rounded-xl border border-gray-200 shadow-sm">
      <div className="flex justify-between items-center mb-2">
        <span className="text-sm text-gray-600 font-medium">{label}</span>
        <span className={`text-xs px-2 py-0.5 rounded-full ${status === 'achieved' ? 'bg-green-100 text-green-700' : status === 'behind' ? 'bg-red-100 text-red-700' : 'bg-amber-100 text-amber-700'}`}>
          {getStatusText()}
        </span>
      </div>
      <div className="flex items-end gap-2 mb-2">
        <span className="text-2xl font-bold text-gray-900">‚Çπ{value?.toLocaleString()}</span>
        <span className="text-sm text-gray-400 mb-1">/ ‚Çπ{max?.toLocaleString()}</span>
      </div>
      <div className="w-full bg-gray-200 rounded-full h-2.5">
        <div 
          className={`h-2.5 rounded-full transition-all duration-500 ${getStatusColor()}`} 
          style={{ width: `${percentage}%` }}
        />
      </div>
    </div>
  );
};

// --- 2. Component Registry ---

const COMPONENT_REGISTRY = {
  // Map Native Thesys Components to Local Equivalents
  'Card': ({ children }) => (
    <div className="bg-white p-3 sm:p-4 rounded-lg sm:rounded-xl border border-gray-200 shadow-sm space-y-3 sm:space-y-4 overflow-visible">
      {children}
    </div>
  ),
  'InlineHeader': ({ heading, description }) => {
    // Parse markdown bold
    const parseMarkdown = (text) => {
      if (!text) return text;
      const parts = text.split(/(\*\*[^*]+\*\*)/g);
      return parts.map((part, i) => {
        if (part.startsWith('**') && part.endsWith('**')) {
          return <strong key={i} className="font-semibold">{part.slice(2, -2)}</strong>;
        }
        return part;
      });
    };
    
    return (
      <div className="mb-2 sm:mb-3">
        <h3 className="text-sm sm:text-lg font-bold text-gray-900 leading-tight">{heading}</h3>
        {description && <p className="text-xs sm:text-sm text-gray-600 mt-1 sm:mt-1.5 leading-snug">{parseMarkdown(description)}</p>}
      </div>
    );
  },
  // ReasoningBlock - Shows AI's reasoning process (30% of judging!)
  'ReasoningBlock': ({ steps, conclusion, confidence }) => {
    const getConfidenceConfig = () => {
      if (confidence === 'high') return { 
        bg: 'bg-emerald-50', 
        border: 'border-emerald-200', 
        text: 'text-emerald-700',
        icon: '‚úì',
        label: 'High Confidence'
      };
      if (confidence === 'medium') return { 
        bg: 'bg-amber-50', 
        border: 'border-amber-200', 
        text: 'text-amber-700',
        icon: '~',
        label: 'Medium Confidence'
      };
      return { 
        bg: 'bg-slate-50', 
        border: 'border-slate-200', 
        text: 'text-slate-600',
        icon: '?',
        label: 'Limited Data'
      };
    };
    
    const conf = getConfidenceConfig();
    
    return (
      <div className="my-3 sm:my-4 rounded-xl border-2 border-indigo-100 bg-gradient-to-br from-indigo-50/80 via-white to-purple-50/50 shadow-sm overflow-hidden">
        {/* Header */}
        <div className="px-3 sm:px-4 py-2.5 bg-gradient-to-r from-indigo-100/80 to-purple-100/50 border-b border-indigo-100">
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-2">
              <div className="w-7 h-7 rounded-lg bg-indigo-500 flex items-center justify-center shadow-sm">
                <span className="text-white text-sm">üß†</span>
              </div>
              <div>
                <span className="text-sm font-bold text-indigo-900">My Analysis</span>
                <p className="text-[10px] text-indigo-600">Here's how I reached this conclusion</p>
              </div>
            </div>
            {confidence && (
              <div className={`flex items-center gap-1.5 px-2.5 py-1 rounded-full ${conf.bg} ${conf.border} border`}>
                <span className={`text-xs font-bold ${conf.text}`}>{conf.icon}</span>
                <span className={`text-[10px] font-semibold ${conf.text}`}>{conf.label}</span>
              </div>
            )}
          </div>
        </div>
        
        {/* Steps */}
        {steps && steps.length > 0 && (
          <div className="px-3 sm:px-4 py-3">
            <div className="space-y-2">
              {steps.map((step, idx) => (
                <div key={idx} className="flex items-start gap-3 group">
                  <div className="flex-shrink-0 w-6 h-6 rounded-full bg-indigo-100 flex items-center justify-center mt-0.5 group-hover:bg-indigo-200 transition-colors">
                    <span className="text-xs font-bold text-indigo-600">{idx + 1}</span>
                  </div>
                  <p className="text-sm text-gray-700 leading-relaxed pt-0.5">{step}</p>
                </div>
              ))}
            </div>
          </div>
        )}
        
        {/* Conclusion */}
        {conclusion && (
          <div className="mx-3 sm:mx-4 mb-3 p-3 rounded-lg bg-gradient-to-r from-indigo-500 to-purple-500 shadow-md">
            <div className="flex items-start gap-2">
              <span className="text-lg">üí°</span>
              <div>
                <span className="text-[10px] font-semibold text-indigo-100 uppercase tracking-wide">Key Takeaway</span>
                <p className="text-sm font-semibold text-white mt-0.5">{conclusion}</p>
              </div>
            </div>
          </div>
        )}
      </div>
    );
  },
  
  // AssumptionsBlock - Communicates uncertainty and assumptions honestly
  'AssumptionsBlock': ({ assumptions, dataQuality }) => {
    const qualityConfig = {
      complete: { icon: '‚úì', label: 'Complete Data', color: 'text-emerald-600 bg-emerald-50' },
      partial: { icon: '~', label: 'Partial Data', color: 'text-amber-600 bg-amber-50' },
      limited: { icon: '!', label: 'Limited Data', color: 'text-red-600 bg-red-50' }
    };
    const quality = qualityConfig[dataQuality] || qualityConfig.partial;
    
    return (
      <div className="my-2 p-3 rounded-lg bg-slate-50 border border-slate-200">
        <div className="flex items-center gap-2 mb-2">
          <span className={`w-5 h-5 rounded-full flex items-center justify-center text-xs font-bold ${quality.color}`}>
            {quality.icon}
          </span>
          <span className="text-xs font-semibold text-slate-700">{quality.label}</span>
        </div>
        {assumptions && assumptions.length > 0 && (
          <div className="space-y-1.5">
            <span className="text-[10px] uppercase tracking-wide font-semibold text-slate-500">Assumptions Made:</span>
            <ul className="space-y-1">
              {assumptions.map((item, idx) => (
                <li key={idx} className="flex items-start gap-2 text-xs text-slate-600">
                  <span className="text-slate-400">‚Ä¢</span>
                  <span>{item}</span>
                </li>
              ))}
            </ul>
          </div>
        )}
      </div>
    );
  },
  
  // ConfidenceIndicator - Simple confidence badge
  'ConfidenceIndicator': ({ level, reason }) => {
    const styles = {
      high: 'bg-green-50 border-green-200 text-green-700',
      medium: 'bg-amber-50 border-amber-200 text-amber-700',
      low: 'bg-red-50 border-red-200 text-red-600'
    };
    const icons = { high: '‚úì', medium: '~', low: '?' };
    
    return (
      <div className={`inline-flex items-center gap-1.5 px-2 py-1 rounded-full border text-xs font-medium ${styles[level] || styles.medium}`}>
        <span>{icons[level] || '~'}</span>
        <span>{level} confidence</span>
        {reason && <span className="text-gray-500">¬∑ {reason}</span>}
      </div>
    );
  },
  
  // DecisionJustification - Explains WHY a recommendation is being made
  'DecisionJustification': ({ recommendation, reasons, impact, alternative }) => {
    return (
      <div className="my-3 rounded-xl border-2 border-amber-200 bg-gradient-to-br from-amber-50 to-orange-50 overflow-hidden">
        {/* Header */}
        <div className="px-3 py-2.5 bg-gradient-to-r from-amber-100 to-orange-100 border-b border-amber-200">
          <div className="flex items-center gap-2">
            <div className="w-7 h-7 rounded-lg bg-amber-500 flex items-center justify-center shadow-sm">
              <span className="text-white text-sm">üí°</span>
            </div>
            <div>
              <span className="text-sm font-bold text-amber-900">Recommendation</span>
              <p className="text-[10px] text-amber-700">Based on your data analysis</p>
            </div>
          </div>
        </div>
        
        {/* Recommendation */}
        <div className="px-3 py-3">
          <p className="text-sm font-semibold text-gray-800 mb-3">{recommendation}</p>
          
          {/* Reasons */}
          {reasons && reasons.length > 0 && (
            <div className="mb-3">
              <span className="text-[10px] uppercase tracking-wide font-semibold text-amber-700 mb-1.5 block">Why I suggest this:</span>
              <ul className="space-y-1.5">
                {reasons.map((reason, idx) => (
                  <li key={idx} className="flex items-start gap-2 text-xs text-gray-600">
                    <span className="text-amber-500 mt-0.5">‚Üí</span>
                    <span>{reason}</span>
                  </li>
                ))}
              </ul>
            </div>
          )}
          
          {/* Impact */}
          {impact && (
            <div className="p-2 rounded-lg bg-green-50 border border-green-200 mb-2">
              <div className="flex items-center gap-2">
                <span className="text-green-600">üìà</span>
                <span className="text-xs font-medium text-green-700">Expected Impact: {impact}</span>
              </div>
            </div>
          )}
          
          {/* Alternative */}
          {alternative && (
            <div className="p-2 rounded-lg bg-slate-50 border border-slate-200">
              <span className="text-[10px] text-slate-500 font-medium">Alternative approach: </span>
              <span className="text-xs text-slate-600">{alternative}</span>
            </div>
          )}
        </div>
      </div>
    );
  },
  
  'DataTile': ({ amount, description, child }) => (
    <div className="flex flex-col">
      <span className="text-[10px] sm:text-xs text-gray-500 uppercase tracking-wide font-semibold">{description}</span>
      <div className="flex items-center gap-1.5 sm:gap-2 mt-0.5 sm:mt-1">
        {child}
        <span className="text-base sm:text-2xl font-bold text-gray-900">{amount}</span>
      </div>
    </div>
  ),
  'Stats': ({ number, label }) => (
    <div className="flex flex-col items-end">
      <span className={`text-xs sm:text-sm font-bold ${number?.includes('-') ? 'text-red-600' : 'text-green-600'}`}>
        {number}
      </span>
      <span className="text-[10px] sm:text-xs text-gray-400">{label}</span>
    </div>
  ),
  'PieChartV2': ({ chartData, onDrillDown, ...props }) => {
    // Adapter: Transform Thesys V2 data to Local Chart data
    // Map 'value' to 'amount' and 'category' to 'category'
    const rawData = chartData?.data || [];
    const total = rawData.reduce((sum, d) => sum + (d.value || 0), 0);
    
    const adaptedData = rawData.map(d => ({ 
      category: d.category, 
      amount: d.value,
      percentage: total > 0 ? Math.round((d.value / total) * 100) : 0
    }));

    return (
      <div className="w-full overflow-visible">
         <InteractivePieChart 
            data={adaptedData} 
            title={chartData?.header?.props?.heading}
            onDrillDown={onDrillDown}
            {...props} 
         />
      </div>
    );
  },
  'BarChartV2': ({ chartData, onDrillDown, ...props }) => {
    // Adapter: Transform Thesys V2 data to Local Chart data
    // Structure: labels: ["A", "B"], series: [{ values: [10, 20] }]
    const labels = chartData?.data?.labels || [];
    const values = chartData?.data?.series?.[0]?.values || [];
    
    // Zip labels and values into [{ name: "A", amount: 10 }, ...]
    const adaptedData = labels.map((label, idx) => ({
      name: label,
      amount: values[idx] || 0
    }));

    return (
      <div className="w-full">
        <InteractiveBarChart 
            data={adaptedData} 
            title={chartData?.header?.props?.heading}
            onDrillDown={onDrillDown}
            {...props} 
        />
      </div>
    );
  },
  'LineChartV2': ({ chartData, onDrillDown, ...props }) => {
    // Adapter: Transform Thesys V2 line chart data to Local Chart data
    // Structure: labels: ["Day1", "Day2"], series: [{ values: [100, 200] }]
    const labels = chartData?.data?.labels || [];
    const values = chartData?.data?.series?.[0]?.values || [];
    
    // Zip labels and values into [{ date: "Day1", amount: 100 }, ...]
    const adaptedData = labels.map((label, idx) => ({
      date: label,
      amount: values[idx] || 0
    }));

    return (
      <div className="w-full">
        <InteractiveTimelineChart 
            data={adaptedData} 
            title={chartData?.header?.props?.heading}
            {...props} 
        />
      </div>
    );
  },
  'CalloutV2': ({ variant, title, description, children }) => {
    // Parse simple markdown (bold **text**)
    const parseMarkdown = (text) => {
      if (!text) return text;
      const parts = text.split(/(\*\*[^*]+\*\*)/g);
      return parts.map((part, i) => {
        if (part.startsWith('**') && part.endsWith('**')) {
          return <strong key={i} className="font-semibold">{part.slice(2, -2)}</strong>;
        }
        return part;
      });
    };
    
    return (
      <div className={`p-3 sm:p-4 rounded-lg border my-2 sm:my-3 ${
        variant === 'warning' ? 'bg-amber-50 border-amber-200 text-amber-800' :
        variant === 'success' ? 'bg-green-50 border-green-200 text-green-800' :
        variant === 'error' ? 'bg-red-50 border-red-200 text-red-800' :
        'bg-blue-50 border-blue-200 text-blue-800'
      }`}>
        {title && <div className="font-semibold text-sm mb-1">{title}</div>}
        {description && <div className="text-xs sm:text-sm leading-relaxed">{parseMarkdown(description)}</div>}
        {children}
      </div>
    );
  },
  'TagBlock': ({ children }) => (
    <div className="flex flex-wrap gap-1.5 sm:gap-2 mt-1.5 sm:mt-2">
      {children}
    </div>
  ),
  'Tag': ({ text, variant, onAction }) => (
    <button
      onClick={() => onAction && onAction(text)}
      className={`px-2 sm:px-3 py-1 sm:py-1.5 rounded-full text-[10px] sm:text-xs font-medium border cursor-pointer transition-all active:scale-95 ${
        variant === 'info' ? 'bg-blue-50 text-blue-700 border-blue-200 active:bg-blue-100' :
        variant === 'warning' ? 'bg-amber-50 text-amber-700 border-amber-200 active:bg-amber-100' :
        'bg-gray-50 text-gray-700 border-gray-200 active:bg-gray-100'
      }`}
    >
      {text}
    </button>
  ),
  // Additional Thesys Components - Enhanced List with items array support
  'List': ({ children, items, variant, heading, onAction }) => {
    // Support both children-based and items array format from Thesys
    if (items && items.length > 0) {
      return (
        <div className="my-2 sm:my-3">
          {heading && <h4 className="text-xs sm:text-sm font-semibold text-gray-700 mb-2">{heading}</h4>}
          <ul className="space-y-1.5 sm:space-y-2">
            {items.map((item, idx) => (
              <li 
                key={idx} 
                className={`flex items-start gap-2 sm:gap-3 p-2 sm:p-2.5 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors ${onAction ? 'cursor-pointer' : ''}`}
                onClick={() => onAction && onAction(item.title)}
              >
                <span className="text-amber-500 mt-0.5 font-semibold text-xs">
                  {variant === 'number' ? `${idx + 1}.` : '‚Ä¢'}
                </span>
                <div className="flex-1 min-w-0">
                  <div className="text-xs sm:text-sm font-medium text-gray-800 truncate">{item.title}</div>
                  {item.subtitle && <div className="text-[10px] sm:text-xs text-gray-500 mt-0.5">{item.subtitle}</div>}
                </div>
                {item.iconName && <span className="text-amber-600">‚Üí</span>}
              </li>
            ))}
          </ul>
        </div>
      );
    }
    // Fallback to children-based rendering
    return (
      <ul className="space-y-1.5 sm:space-y-2 my-1.5 sm:my-2">
        {children}
      </ul>
    );
  },
  'ListItem': ({ children, text, title, subtitle, onAction }) => (
    <li 
      className={`flex items-start gap-1.5 sm:gap-2 text-xs sm:text-sm text-gray-700 ${onAction ? 'cursor-pointer hover:text-amber-700' : ''}`}
      onClick={() => onAction && onAction(text || title)}
    >
      <span className="text-amber-500 mt-0.5">‚Ä¢</span>
      <div>
        <span>{text || title || children}</span>
        {subtitle && <span className="text-gray-500 ml-1">- {subtitle}</span>}
      </div>
    </li>
  ),
  'FollowUpBlock': ({ children, followUpText, onAction, title }) => {
    // Handle both children-based and followUpText-based formats from Thesys
    const items = followUpText || [];
    return (
      <div className="mt-3 sm:mt-4 pt-3 sm:pt-4 border-t border-gray-200">
        {title && (
          <div className="text-xs text-gray-500 mb-2 font-medium">
            üí° {title || "Explore further:"}
          </div>
        )}
        <div className="flex flex-wrap gap-1.5 sm:gap-2">
          {items.length > 0 ? items.map((text, idx) => (
            <button
              key={idx}
              onClick={() => onAction && onAction(text)}
              className="px-3 sm:px-4 py-2 sm:py-2.5 bg-gradient-to-r from-amber-50 to-orange-50 text-amber-800 rounded-xl text-xs sm:text-sm font-medium active:scale-95 hover:from-amber-100 hover:to-orange-100 transition-all border border-amber-200 shadow-sm hover:shadow"
            >
              {text}
            </button>
          )) : children}
        </div>
      </div>
    );
  },
  // ClarificationCard - Special component for asking follow-up questions
  'ClarificationCard': ({ question, options, onAction }) => (
    <div className="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-xl p-4 border border-blue-200 shadow-sm">
      <div className="flex items-start gap-2 mb-3">
        <span className="text-xl">ü§î</span>
        <div>
          <h4 className="font-semibold text-gray-800 text-sm">Let me understand better</h4>
          <p className="text-xs text-gray-600 mt-0.5">{question || "What would you like to explore?"}</p>
        </div>
      </div>
      <div className="flex flex-wrap gap-2">
        {(options || []).map((opt, idx) => (
          <button
            key={idx}
            onClick={() => onAction && onAction(opt)}
            className="px-3 py-2 bg-white text-blue-700 rounded-lg text-xs font-medium border border-blue-200 hover:bg-blue-50 hover:border-blue-300 transition-all active:scale-95 shadow-sm"
          >
            {opt}
          </button>
        ))}
      </div>
    </div>
  ),
  'FollowUp': ({ text, onAction }) => (
    <button
      onClick={() => onAction && onAction(text)}
      className="px-2 sm:px-3 py-1 sm:py-1.5 bg-amber-50 text-amber-700 rounded-lg text-[10px] sm:text-sm font-medium active:bg-amber-100 transition-colors border border-amber-200"
    >
      {text}
    </button>
  ),
  'Callout': ({ children, variant }) => (
    <div className={`p-3 rounded-lg border my-2 ${
      variant === 'warning' ? 'bg-amber-50 border-amber-200 text-amber-800' :
      variant === 'success' ? 'bg-green-50 border-green-200 text-green-800' :
      variant === 'error' ? 'bg-red-50 border-red-200 text-red-800' :
      'bg-blue-50 border-blue-200 text-blue-800'
    }`}>
      {children}
    </div>
  ),

  'Header': ({ title, subtitle }) => (
    <div className="mb-2 sm:mb-4">
      <h3 className="text-sm sm:text-lg font-bold text-gray-900">{title}</h3>
      {subtitle && <p className="text-xs sm:text-sm text-gray-500">{subtitle}</p>}
    </div>
  ),
  'TextContent': ({ textMarkdown }) => {
    // Parse markdown: **bold**, *italic*, `code`
    const parseMarkdown = (text) => {
      if (!text) return text;
      // Split by bold markers first
      const parts = text.split(/(\*\*[^*]+\*\*)/g);
      return parts.map((part, i) => {
        if (part.startsWith('**') && part.endsWith('**')) {
          return <strong key={i} className="font-semibold text-gray-800">{part.slice(2, -2)}</strong>;
        }
        return part;
      });
    };
    
    return (
      <div className="prose text-xs sm:text-sm text-gray-600 mb-1.5 sm:mb-2">
        {textMarkdown && textMarkdown.split('\n').map((line, i) => (
          <p key={i} className="mb-0.5 sm:mb-1 leading-relaxed">{parseMarkdown(line)}</p>
        ))}
      </div>
    );
  },
  'MiniCardBlock': Row,
  'MiniCard': ({ lhs, rhs }) => (
    <div className="flex items-center justify-between gap-2 sm:gap-3 p-2 sm:p-3 bg-white border border-gray-200 rounded-lg shadow-sm flex-1 min-w-0">
      {lhs && <div className="flex-shrink-0">{lhs}</div>}
      {rhs && <div className="flex-grow text-right">{rhs}</div>}
    </div>
  ),
  'ProfileTile': ({ title, label, child }) => (
     <div className="flex flex-col">
        <span className="text-[10px] sm:text-xs text-gray-500 uppercase tracking-wide">{label}</span>
        <div className="flex items-center gap-1.5 sm:gap-2 mt-0.5 sm:mt-1">
           {child}
           <span className="text-sm sm:text-base font-semibold text-gray-900">{title}</span>
        </div>
     </div>
  ),
  'Icon': ({ name, category }) => {
      // Expanded icon mapper (Fix #6)
      const iconMap = {
        // Financial
        'dollar-sign': IndianRupee,
        'indian-rupee': IndianRupee,
        'rupee': IndianRupee,
        'currency': IndianRupee,
        'wallet': IndianRupee,
        // Trends
        'trending-up': TrendingUp,
        'trending-down': TrendingDown,
        'arrow-up': TrendingUp,
        'arrow-down': TrendingDown,
        // Charts
        'bar-chart': TrendingUp,
        'bar-chart-3': TrendingUp,
        'bar-chart-2': TrendingUp,
        'pie-chart': Target,
        'line-chart': TrendingUp,
        // Alerts
        'alert-triangle': AlertTriangle,
        'alert-circle': AlertTriangle,
        'warning': AlertTriangle,
        // Business
        'package': Package,
        'box': Package,
        'inventory': Package,
        'shopping-cart': ShoppingCart,
        'cart': ShoppingCart,
        'shop': ShoppingCart,
        // Documents
        'file-text': Package,
        'file': Package,
        'document': Package,
        // Goals
        'target': Target,
        'goal': Target,
        'bullseye': Target
      };
      const LucideIcon = iconMap[name] || iconMap[category] || IndianRupee;
      return <LucideIcon className="w-4 h-4 sm:w-5 sm:h-5 text-amber-600" />;
  },
  'Button': ({ children, variant, onAction, name }) => (
      <button 
        onClick={() => onAction && onAction(name)}
        className={`px-4 py-2 rounded-lg text-sm font-medium transition-colors ${
          variant === 'primary' 
            ? 'bg-amber-600 text-white hover:bg-amber-700' 
            : 'bg-white text-gray-700 border border-gray-300 hover:bg-gray-50'
        }`}
      >
        {children}
      </button>
  ),
  'ButtonGroup': ({ children, className }) => (
      <div className={`flex flex-wrap gap-2 mt-4 ${className || ''}`}>{children}</div>
  ),

  // Layouts
  'container': Container,
  'row': Row,
  'column': Column,
  'grid': DashboardGrid,
  
  // Primitives (Vendor-focused)
  'metric_card': MetricCard,
  'gauge': GaugeCard,
  
  // Charts
  'bar_chart': InteractiveBarChart,
  'pie_chart': InteractivePieChart,
  'line_chart': InteractiveTimelineChart,
  
  // Features
  'comparison': ComparisonView,
  'anomaly': AnomalyCard,
  'simulation': SimulationSlider,
  'decision': DecisionGuide,
  'change_detection': ChangeDetection,
  'clarification': ClarificationOptions
};

/**
 * Recursive Renderer
 * Traverses the JSON tree and renders React components
 */
const renderTree = (node, key, handlers) => {
  if (!node) {
      return null;
  }
  
  // If node is just a string/number, render it
  if (typeof node === 'string' || typeof node === 'number') {
      // console.log('[ThesysGenUI] renderTree: Rendering primitive', node);
      return node;
  }

  // ROBUSTNESS FIX: Handle both "props" wrapper and flat properties
  // The AI sometimes forgets to wrap properties in a "props" object.
  // Thesys Native uses "component" instead of "type"
  const { type, component, children: directChildren, props: explicitProps, ...flatProps } = node;
  
  // Resolve type from either "type" or "component"
  let resolvedType = type || component;

  // HEURISTIC: If no type is found, try to infer from properties
  if (!resolvedType) {
    if (flatProps.text && flatProps.variant) resolvedType = 'Tag';
    else if (flatProps.textMarkdown) resolvedType = 'TextContent';
  }

  // console.log(`[ThesysGenUI] renderTree: Resolving component '${resolvedType}'`, { key, explicitProps, flatProps });

  // Resolve Children from either direct children OR props.children
  // Priority: Direct > Props.children
  let childrenToRender = directChildren;
  if (!childrenToRender && explicitProps && explicitProps.children) {
    childrenToRender = explicitProps.children;
  }
  
  // Clean props to avoid passing raw objects as children to React Components
  const { children: propsChildren, ...cleanExplicitProps } = explicitProps || {};

  // Merge explicit props (if any) with flat properties
  const mergedProps = {
    ...cleanExplicitProps,
    ...flatProps
  };

  // PRE-RENDER any prop that looks like a component object (has "component" or "type" key)
  // This fixes the "Objects are not valid as a React child" error for nested props like lhs, rhs, child
  const processedProps = {};
  for (const [propKey, propValue] of Object.entries(mergedProps)) {
    if (propValue && typeof propValue === 'object' && !Array.isArray(propValue)) {
      // Check if it looks like a component definition
      if (propValue.component || propValue.type) {
        processedProps[propKey] = renderTree(propValue, `${key}-prop-${propKey}`, handlers);
      } else {
        processedProps[propKey] = propValue;
      }
    } else {
      processedProps[propKey] = propValue;
    }
  }

  const Component = COMPONENT_REGISTRY[resolvedType] || COMPONENT_REGISTRY['container']; // Fallback
  
  if (!COMPONENT_REGISTRY[resolvedType]) {
    console.warn(`[ThesysGenUI] Unknown component type: '${resolvedType}'. Falling back to container.`);
  }

  // Prepare props with handlers
  const componentProps = {
    ...processedProps,
    onAction: handlers.onAction, // Pass global handlers down
    onDrillDown: handlers.onDrillDown,
    onSimulate: handlers.onSimulate
  };

  // If children exist, recursively render them
  const renderedChildren = Array.isArray(childrenToRender)
    ? childrenToRender.map((child, idx) => renderTree(child, `${key}-${idx}`, handlers))
    : childrenToRender
      ? renderTree(childrenToRender, `${key}-0`, handlers)
      : null;

  return (
    <Component key={key} {...componentProps}>
      {renderedChildren}
    </Component>
  );
};

/**
 * Main Entry Point
 * @param {string} componentType - The root alias (or 'layout' for full genUI)
 * @param {object} data - The props or the full layout JSON
 * @param {function} onAction - Handler for clicks/suggestions
 * @param {function} onDrillDown - Handler for chart clicks
 */
const ThesysGenUI = ({ componentType, data, onAction, onDrillDown }) => {
  // Interaction Handlers (passed down to all components)
  const handlers = {
    onAction,
    onDrillDown,
    onSimulate: (val) => onAction ? onAction(`Simulate: ${JSON.stringify(val)}`) : null
  };

  // MODE A: Full Generative Layout (New Engine)
  // Server sends: componentType="layout", data={ type: "row", children: [...] }
  if (componentType === 'layout' || componentType === 'genui' || componentType === 'thesys_genui') {
    // Unwrap data if it comes from the API wrapper
    const layoutData = data.generated_ui || data;
    
    return (
      <div className="w-full my-4 animate-fade-in">
        {renderTree(layoutData, 'root', handlers)}
      </div>
    );
  }

  // MODE B: Single Component (Backward Compatibility / Fallback)
  // Server sends: componentType="bar_chart", data={...props}
  // We wrap it in a mock layout node to reuse the renderer
  const rootNode = {
    type: componentType,
    props: data.generated_ui || data
  };

  return (
    <div className="w-full my-2 animate-slide-up">
      {renderTree(rootNode, 'single-root', handlers)}
    </div>
  );
};

export default ThesysGenUI;
